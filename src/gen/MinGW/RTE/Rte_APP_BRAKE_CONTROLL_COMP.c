/** @file     Rte_APP_BRAKE_CONTROLL_COMP.c
  *
  * @brief    RTE Sample SWC implementation skeleton file
  *
  * @note     AUTOMATICALLY GENERATED FILE! DO NOT EDIT!
  *
  * @note     Generated by ETAS GmbH  RTA-RTE v5.10.0  (R4.0 backend version: v7.10.4 (Build 52732))
  */

#include "Rte_APP_BRAKE_CONTROLL_COMP.h"
#include "virtualdevices.h"
/* --------------------------------------------------------------------------- */
/* RTE Event: /Application/APP_BRAKE_CONTROLL_COMP/IB_BRAKE_CONTROLLER/DataReceivedEvent_0 */
int FL_array[5] = {100, 100, 100, 100, 100};
int FL_array2[5] = {0, };
int FR_array[5] = {0, };
int RL_array[5] = {0, };
int RR_array[5] = {0, };
int diff_arr2[5] = {0, };
int diff_arr[5] = {0, };
int FR_diff_arr[5] = {0, };
int RL_diff_arr[5] = {0, };
int RR_diff_arr[5] = {0, };
int fl_cnt1 = 0;
int fl_cnt2 = 0;
int fr_cnt = 0;
int rl_cnt = 0;
int rr_cnt = 0;
int prevalue = 0;
int abs = 0;
int abs_n = 0;
int FR_abs = 0;
int RL_abs = 0;
int RR_abs = 0;
int cnt = 0;
int cnt2 = 0;
int cnt3 = 0;
int cnt4 = 0;
int cnt5 = 0;
int abs1[3] = {0, };
int abs2[3] = {0, };
int abs_r1[3] = {0, };
int abs_r2[3] = {0, };
int abs_fr1[3] = {0, };
int abs_fr2[3] = {0, };
int abs_rl1[3] = {0, };
int abs_rl2[3] = {0, };
int abs_rr1[3] = {0, };
int abs_rr2[3] = {0, };

// Only Front Left ABS App has a debug mode for the simulation
FUNC(void, APP_BRAKE_CONTROLL_COMP_CODE) RE_APP_FL_DATA_RECEV_func(void)
{
	int value, debug_flag, value2, value3;
	int size = sizeof(FL_array) / sizeof(int);

	debug_flag = DebugSensorValue();
	if (debug_flag == 0) {
		value2 = Rte_DRead_APP_Speed_Receive_frontleft();
		if (value2 < 0) { // when you drive backward
			value2 = value2 * (-1);
		}
		FL_array2[fl_cnt2 % size] = value2;

		if (fl_cnt2 == 0) {
			diff_arr2[fl_cnt2 % size] = FL_array2[fl_cnt2 % size] - FL_array2[size - 1];
		} else {
			diff_arr2[fl_cnt2 % size] = FL_array2[fl_cnt2 % size] - FL_array2[(fl_cnt2 % size) -1];
		}

		double sum = 0.0;
		for (int i = 0; i < size; i++)
		{
			if (fl_cnt2 != 0) {
				if (i == fl_cnt2 - 1) {
					sum += diff_arr2[i] * 2.5;
				}
				else if (i == fl_cnt2) {
					sum += diff_arr2[i] * 4;
				} else {
					sum += diff_arr2[i];
				}
			} else {
				if (i == size - 1) {
					sum += diff_arr2[i] * 2.5;
				}
				else if (i == fl_cnt2) {
					sum += diff_arr2[i] * 4;
				} else {
					sum += diff_arr2[i];
				}
			}
		}
		//status_printf("sum : %f\n", sum);
		double avg = sum / size;
		//status_printf("avg : %f\n", avg);

		if (abs_n == 1 && abs_r1[0] != 2) {
			if (cnt2 == (sizeof(abs_r1) / sizeof(int)) - 1) {
				abs_r1[cnt2] = 1;
				abs_r1[0] = 2;
				cnt2 = 0;
			} else {
				abs_r1[cnt2++] = 1;
			}
		} else if (abs_n == 2 && abs_r2[0] != 2) {
			if (cnt2 == (sizeof(abs_r2) / sizeof(int)) - 1) {
				abs_r2[cnt2] = 1;
				abs_r2[0] = 2;
				cnt2 = 0;
			} else {
				abs_r2[cnt2++] = 1;
			}
		} else {
			if (abs_r1[0] == 2) {
				for (int i = 0; i < sizeof(abs_r1) / sizeof(int); i++)
				{
					abs_r1[i] = 0;
				}
			}
			if (abs_r2[0] == 2) {
				for (int i = 0; i < sizeof(abs_r2) / sizeof(int); i++)
				{
					abs_r2[i] = 0;
				}
			}
			if (avg > -5) { // no braking + normal braking
				if (abs_n == 2) {
					abs_n = 1;
					Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(1);
				} else if (abs_n == 1) {
					abs_n = 0;
					Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(0);
				} else {
					Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(0);
				}
			} else {
				if (abs_n == 0) {
					abs_n = 1;
					Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(1);
				} else {
					abs_n = 2;
					Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(2);
				}
			}
		}

		if (fl_cnt2 < 4) {
			fl_cnt2++; }
		else
		{
			fl_cnt2 = 0;
		}
	} else if (debug_flag == 1) {
		value = FL_Speed_SensorValue();
		if (value < 0) {
			value = value * (-1);
		}
		if (prevalue != value) {
			FL_array[fl_cnt1 % size] = value;
			prevalue = value;

			if (fl_cnt1 == 0) {
				diff_arr[fl_cnt1 % size] = FL_array[fl_cnt1 % size] - FL_array[size - 1];
			} else {
				diff_arr[fl_cnt1 % size] = FL_array[fl_cnt1 % size] - FL_array[(fl_cnt1 % size) -1];
			}

			for (int i = 0; i < size; i++)
			{
				status_printf("real : %d\n", FL_array[i]);
			}

			for (int i = 0; i < size; i++)
			{
				status_printf("diff : %d\n", diff_arr[i]);
			}
			double sum = 0.0;
			for (int i = 0; i < size; i++)
			{
				if (fl_cnt1 != 0) {
					if (i == fl_cnt1 - 1) {
						sum += diff_arr[i] * 2.5;
					}
					else if (i == fl_cnt1) {
						sum += diff_arr[i] * 4;
					} else {
						sum += diff_arr[i];
					}
				} else {
					if (i == size - 1) {
						sum += diff_arr[i] * 2.5;
					}
					else if (i == fl_cnt1) {
						sum += diff_arr[i] * 4;
					} else {
						sum += diff_arr[i];
					}
				}
			}
			status_printf("sum : %f\n", sum);
			double avg = sum / size;
			status_printf("avg : %f\n", avg);

			if (abs == 1 && abs1[0] != 2) {
				if (cnt == (sizeof(abs1) / sizeof(int)) - 1) {
					abs1[cnt] = 1;
					abs1[0] = 2;
					cnt = 0;
				} else {
					abs1[cnt++] = 1;
				}
			} else if (abs == 2 && abs2[0] != 2) {
				if (cnt == (sizeof(abs2) / sizeof(int)) - 1) {
					abs2[cnt] = 1;
					abs2[0] = 2;
					cnt = 0;
				} else {
					abs2[cnt++] = 1;
				}
			} else {
				if (abs1[0] == 2) {
					for (int i = 0; i < sizeof(abs1) / sizeof(int); i++)
					{
						abs1[i] = 0;
					}
				}
				if (abs2[0] == 2) {
					for (int i = 0; i < sizeof(abs2) / sizeof(int); i++)
					{
						abs2[i] = 0;
					}
				}
				if (avg > -5) { // no braking + normal braking
					if (abs == 2) {
						abs = 1;
						Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(1);
					} else if (abs == 1) {
						abs = 0;
						Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(0);
					} else {
						Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(0);
					}
				} else {
					if (abs == 0) {
						abs = 1;
						Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(1);
					} else {
						abs = 2;
						Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FL_Mode_Send_modedata(2);
					}
				}
			}

			if (fl_cnt1 < 4) {
				fl_cnt1++; }
			else
			{
				fl_cnt1 = 0;
			}
		}
	}
}

/* --------------------------------------------------------------------------- */
/* RTE Event: /Application/APP_BRAKE_CONTROLL_COMP/IB_BRAKE_CONTROLLER/DataReceivedEvent_1 */

FUNC(void, APP_BRAKE_CONTROLL_COMP_CODE) RE_APP_FR_DATA_RECEV_func(void)
{
	int value;
	int size = sizeof(FR_array) / sizeof(int);

	value = Rte_DRead_APP_Speed_Receive_frontright();
	if (value < 0) {
		value = value * (-1);
	}
	FR_array[fr_cnt % size] = value;

	if (fr_cnt == 0) {
		FR_diff_arr[fr_cnt % size] = FR_array[fr_cnt % size] - FR_array[size - 1];
	} else {
		FR_diff_arr[fr_cnt % size] = FR_array[fr_cnt % size] - FR_array[(fr_cnt % size) -1];
	}

	double sum = 0.0;
	for (int i = 0; i < size; i++)
	{
		if (fr_cnt != 0) {
			if (i == fr_cnt - 1) {
				sum += FR_diff_arr[i] * 2.5;
			}
			else if (i == fr_cnt) {
				sum += FR_diff_arr[i] * 4;
			} else {
				sum += FR_diff_arr[i];
			}
		} else {
			if (i == size - 1) {
				sum += FR_diff_arr[i] * 2.5;
			}
			else if (i == fr_cnt) {
				sum += FR_diff_arr[i] * 4;
			} else {
				sum += FR_diff_arr[i];
			}
		}
	}
	//status_printf("sum : %f\n", sum);
	double avg = sum / size;
	//status_printf("avg : %f\n", avg);

	if (FR_abs == 1 && abs_fr1[0] != 2) {
		if (cnt3 == (sizeof(abs_fr1) / sizeof(int)) - 1) {
			abs_fr1[cnt3] = 1;
			abs_fr1[0] = 2;
			cnt3 = 0;
		} else {
			abs_fr1[cnt3++] = 1;
		}
	} else if (FR_abs == 2 && abs_fr2[0] != 2) {
		if (cnt3 == (sizeof(abs_fr2) / sizeof(int)) - 1) {
			abs_fr2[cnt3] = 1;
			abs_fr2[0] = 2;
			cnt3 = 0;
		} else {
			abs_fr2[cnt3++] = 1;
		}
	} else {
		if (abs_fr1[0] == 2) {
			for (int i = 0; i < sizeof(abs_fr1) / sizeof(int); i++)
			{
				abs_fr1[i] = 0;
			}
		}
		if (abs_fr2[0] == 2) {
			for (int i = 0; i < sizeof(abs_fr2) / sizeof(int); i++)
			{
				abs_fr2[i] = 0;
			}
		}
		if (avg > -5) { // no braking + normal braking
			if (FR_abs == 2) {
				FR_abs = 1;
				Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FR_Mode_Send_modedata(1);
			} else if (FR_abs == 1) {
				FR_abs = 0;
				Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FR_Mode_Send_modedata(0);
			} else {
				Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FR_Mode_Send_modedata(0);
			}
		} else {
			if (FR_abs == 0) {
				FR_abs = 1;
				Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FR_Mode_Send_modedata(1);
			} else {
				FR_abs = 2;
				Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_FR_Mode_Send_modedata(2);
			}
		}
	}

	if (fr_cnt < 4) {
		fr_cnt++; }
	else
	{
		fr_cnt = 0;
	}
}

/* --------------------------------------------------------------------------- */
/* RTE Event: /Application/APP_BRAKE_CONTROLL_COMP/IB_BRAKE_CONTROLLER/DataReceivedEvent_2 */

FUNC(void, APP_BRAKE_CONTROLL_COMP_CODE) RE_APP_RL_DATA_RECEV_func(void)
{
	int value;
	int size = sizeof(RL_array) / sizeof(int);

	value = Rte_DRead_APP_Speed_Receive_backleft();
	if (value < 0) {
		value = value * (-1);
	}
	RL_array[rl_cnt % size] = value;


	if (rl_cnt == 0) {
	RL_diff_arr[rl_cnt % size] = RL_array[rl_cnt % size] - RL_array[size - 1];
	} else {
	RL_diff_arr[rl_cnt % size] = RL_array[rl_cnt % size] - RL_array[(rl_cnt % size) -1];
	}

	double sum = 0.0;
	for (int i = 0; i < size; i++)
	{
	if (rl_cnt != 0) {
		if (i == rl_cnt - 1) {
			sum += RL_diff_arr[i] * 2.5;
		}
		else if (i == rl_cnt) {
			sum += RL_diff_arr[i] * 4;
		} else {
			sum += RL_diff_arr[i];
		}
	} else {
		if (i == size - 1) {
			sum += RL_diff_arr[i] * 2.5;
		}
		else if (i == rl_cnt) {
			sum += RL_diff_arr[i] * 4;
		} else {
			sum += RL_diff_arr[i];
		}
	}
	}
	//status_printf("sum : %f\n", sum);
	double avg = sum / size;
	//status_printf("avg : %f\n", avg);

	if (RL_abs == 1 && abs_rl1[0] != 2) {
	if (cnt4 == (sizeof(abs_rl1) / sizeof(int)) - 1) {
		abs_rl1[cnt4] = 1;
		abs_rl1[0] = 2;
		cnt4 = 0;
	} else {
		abs_rl1[cnt4++] = 1;
	}
	} else if (RL_abs == 2 && abs_rl2[0] != 2) {
	if (cnt4 == (sizeof(abs_rl2) / sizeof(int)) - 1) {
		abs_rl2[cnt4] = 1;
		abs_rl2[0] = 2;
		cnt4 = 0;
	} else {
		abs_rl2[cnt4++] = 1;
	}
	} else {
	if (abs_rl1[0] == 2) {
		for (int i = 0; i < sizeof(abs_rl1) / sizeof(int); i++)
		{
			abs_rl1[i] = 0;
		}
	}
	if (abs_rl2[0] == 2) {
		for (int i = 0; i < sizeof(abs_rl2) / sizeof(int); i++)
		{
			abs_rl2[i] = 0;
		}
	}
	if (avg > -5) { // no braking + normal braking
		if (RL_abs == 2) {
			RL_abs = 1;
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RL_Mode_Send_modedata(1);
		} else if (RL_abs == 1) {
			RL_abs = 0;
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RL_Mode_Send_modedata(0);
		} else {
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RL_Mode_Send_modedata(0);
		}
	} else {
		if (RL_abs == 0) {
			RL_abs = 1;
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RL_Mode_Send_modedata(1);
		} else {
			RL_abs = 2;
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RL_Mode_Send_modedata(2);
		}
	}

	if (rl_cnt < 4) {
		rl_cnt++; }
	else
	{
		rl_cnt = 0;
	}
	}
}

/* --------------------------------------------------------------------------- */
/* RTE Event: /Application/APP_BRAKE_CONTROLL_COMP/IB_BRAKE_CONTROLLER/DataReceivedEvent_3 */

FUNC(void, APP_BRAKE_CONTROLL_COMP_CODE) RE_APP_RR_DATA_RECEV_func(void)
{
	int value;
	int size = sizeof(RR_array) / sizeof(int);

	value = Rte_DRead_APP_Speed_Receive_backright();
	if (value < 0) {
		value = value * (-1);
	}
	RR_array[rr_cnt % size] = value;

	if (rr_cnt == 0) {
		RR_diff_arr[rr_cnt % size] = RR_array[rr_cnt % size] - RR_array[size - 1];
	} else {
		RR_diff_arr[rr_cnt % size] = RR_array[rr_cnt % size] - RR_array[(rr_cnt % size) -1];
	}

	double sum = 0.0;
	for (int i = 0; i < size; i++)
	{
	if (rr_cnt != 0) {
		if (i == rr_cnt - 1) {
			sum += RR_diff_arr[i] * 2.5;
		}
		else if (i == rr_cnt) {
			sum += RR_diff_arr[i] * 4;
		} else {
			sum += RR_diff_arr[i];
		}
	} else {
		if (i == size - 1) {
			sum += RR_diff_arr[i] * 2.5;
		}
		else if (i == rr_cnt) {
			sum += RR_diff_arr[i] * 4;
		} else {
			sum += RR_diff_arr[i];
		}
	}
	}
	//status_printf("sum : %f\n", sum);
	double avg = sum / size;
	//status_printf("avg : %f\n", avg);

	if (RR_abs == 1 && abs_rr1[0] != 2) {
	if (cnt5 == (sizeof(abs_rr1) / sizeof(int)) - 1) {
		abs_rr1[cnt5] = 1;
		abs_rr1[0] = 2;
		cnt5 = 0;
	} else {
		abs_rr1[cnt5++] = 1;
	}
	} else if (RR_abs == 2 && abs_rr2[0] != 2) {
	if (cnt5 == (sizeof(abs_rr2) / sizeof(int)) - 1) {
		abs_rr2[cnt5] = 1;
		abs_rr2[0] = 2;
		cnt5 = 0;
	} else {
		abs_rr2[cnt5++] = 1;
	}
	} else {
	if (abs_rr1[0] == 2) {
		for (int i = 0; i < sizeof(abs_rr1) / sizeof(int); i++)
		{
			abs_rr1[i] = 0;
		}
	}
	if (abs_rr2[0] == 2) {
		for (int i = 0; i < sizeof(abs_rr2) / sizeof(int); i++)
		{
			abs_rr2[i] = 0;
		}
	}
	if (avg > -5) { // no braking + normal braking
		if (RR_abs == 2) {
			RR_abs = 1;
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RR_Mode_Send_modedata(1);
		} else if (RR_abs == 1) {
			RR_abs = 0;
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RR_Mode_Send_modedata(0);
		} else {
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RR_Mode_Send_modedata(0);
		}
	} else {
		if (RR_abs == 0) {
			RR_abs = 1;
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RR_Mode_Send_modedata(1);
		} else {
			RR_abs = 2;
			Rte_Write_APP_BRAKE_CONTROLL_COMP_APP_RR_Mode_Send_modedata(2);
		}
	}
	}

	if (rr_cnt < 4) {
		rr_cnt++; }
	else
	{
		rr_cnt = 0;
	}
}

