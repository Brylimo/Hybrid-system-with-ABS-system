/** @file     Rte_APP_MOTOR_COMP.c
  *
  * @brief    RTE Sample SWC implementation skeleton file
  *
  * @note     AUTOMATICALLY GENERATED FILE! DO NOT EDIT!
  *
  * @note     Generated by ETAS GmbH  RTA-RTE v5.10.0  (R4.0 backend version: v7.10.4 (Build 52732))
  */

#include "Rte_APP_MOTOR_COMP.h"
#include "virtualdevices.h"

int batt_stat, pwm;
int MAX_PWM = 100000;
float BATT_RATIO = 0.6f;
/* --------------------------------------------------------------------------- */
/* RTE Event: /MotorComposition/APP_MOTOR_COMP/IB_APP_MOTOR/TE_300ms */

FUNC(void, APP_MOTOR_COMP_CODE) RE_APP_MOTOR_ACT_func(void)
{
	if(pwm == 0) { // motor => battery charge
		//status_printf("battery charge mode..\r\n");
		Rte_Write_SR_MOTOR_SPEED_Send_motor_speed_data(0);
	}
	else {
		// pwm(percentage) and battery => pwm
		float ratio = 1.0f + (100.0f - batt_stat) * BATT_RATIO / 100.0f;
		//status_printf("ratio:%f\r\n",ratio);
		int motor_pwm = (MAX_PWM * pwm / 100) * ratio;

		Rte_Write_SR_MOTOR_SPEED_Send_motor_speed_data(motor_pwm/10);
	}
}

/* --------------------------------------------------------------------------- */
/* RTE Event: /MotorComposition/APP_MOTOR_COMP/IB_APP_MOTOR/TimingEvent_0 */

int low_flag = 0;

FUNC(void, APP_MOTOR_COMP_CODE) RE_APP_MOTOR_batt_pwm_func(void)
{
	//batt receive
	batt_stat = Rte_DRead_SR_BATT_Recv_batt_data();
	//status_printf("batt received : %d\r\n", batt_stat);

	if(!low_flag && batt_stat <= 10) { //low battery
		low_flag = 1;
		Rte_Trigger_TR_BATT_LOW_set_low();
		//status_printf("low battery!!\r\n");
	}

	if(low_flag && batt_stat > 10) { //battery recharged
		low_flag = 0;
		Rte_Trigger_TR_BATT_LOW_set_normal();
		//status_printf("recharged.\r\n");
	}

	//pwm receive
	pwm = Rte_DRead_SR_PWM_Recv_pwm_data();
	//status_printf("pwm received : %d\r\n", pwm);
}

